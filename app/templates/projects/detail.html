{% extends "base.html" %}
{% block content %}
<section class="project-header">
    <h1>{{ project.name }}</h1>
    <p>Antena: {{ project.antenna.name }} · Frequencia: {{ "%.2f"|format(project.frequency_mhz) }} MHz · Potencia: {{ "%.1f"|format(project.tx_power_w) }} W</p>
    <div class="header-actions">
        <a class="btn" href="{{ url_for('projects.edit', project_id=project.id) }}">Editar</a>
        <a class="btn-primary" href="{{ url_for('projects.export', project_id=project.id) }}">Gerar exportacoes</a>
    </div>
</section>
{% if latest_export %}
<section class="export-panel">
    <h2>Downloads do ultimo processamento ({{ latest_export.created_at.strftime('%d/%m/%Y %H:%M') if latest_export.created_at else 'agora' }})</h2>
    <div class="export-grid">
        <article class="export-card export-card--pdf">
            <header>
                <span class="export-icon">📄</span>
                <h3>Relatorio PDF</h3>
            </header>
            <p>Resumo completo com graficos, tabelas e parametros do projeto.</p>
            <a class="export-action" href="{{ latest_files['pdf'] }}">Baixar PDF</a>
        </article>
        <article class="export-card export-card--pat">
            <header>
                <span class="export-icon">📡</span>
                <h3>Arquivo PAT</h3>
            </header>
            <p>Padrão composto 0°-359° compatível com softwares HFSS.</p>
            <a class="export-action" href="{{ latest_files['pat'] }}">Baixar PAT</a>
        </article>
        <article class="export-card export-card--prn">
            <header>
                <span class="export-icon">📈</span>
                <h3>Arquivo PRN</h3>
            </header>
            <p>Tabela de atenuacoes positivas (dB) para simuladores de campo.</p>
            <a class="export-action" href="{{ latest_files['prn'] }}">Baixar PRN</a>
        </article>
        <article class="export-card export-card--bundle">
            <header>
                <span class="export-icon">🗂️</span>
                <h3>Pacote ZIP</h3>
            </header>
            <p>PDF + PAT + PRN em um único pacote para facilitar o envio.</p>
            <a class="export-action" href="{{ latest_files['bundle'] }}">Baixar pacote</a>
        </article>
    </div>
</section>
{% endif %}
<section class="pattern-visuals">
    {% for key, preview in previews.items() %}
    <article class="pattern-figure">
        <header>
            <h2>{{ 'Diagrama de Azimute (original)' if key == 'azimuth' else 'Diagrama de Elevacao (original)' }}</h2>
        </header>
        <img src="{{ preview.image }}" alt="Pre-visualizacao {{ key }}" loading="lazy">
        <ul class="metric-list">
            {% for line in preview.stats %}
            <li>{{ line }}</li>
            {% endfor %}
        </ul>
    </article>
    {% endfor %}
</section>
<section>
    <h2>ERP composto (0°-359°)</h2>
    <table class="table table-compact" id="erp-table">
        <thead><tr><th>Angulo</th><th>ERP (W)</th><th>ERP (dBW)</th></tr></thead>
        <tbody>
        {% for angle, erp_w, erp_dbw in erp_rows %}
            <tr>
                <td>{{ "%03d"|format(angle % 360) }}</td>
                <td>{{ "%.2f"|format(erp_w) }}</td>
                <td>{{ "%.2f"|format(erp_dbw) }}</td>
            </tr>
        {% if loop.index % 24 == 0 %}
            <tr class="separator"><td colspan="3"></td></tr>
        {% endif %}
        {% endfor %}
        </tbody>
    </table>
</section>
<section>
    <h2>Exportacoes anteriores</h2>
    <ul>
        {% for export in project.revisions|sort(attribute='created_at', reverse=True) %}
        <li>{{ export.created_at.strftime('%d/%m/%Y %H:%M') if export.created_at else 'sem data' }} -
            <a href="{{ url_for('projects.download', project_id=project.id, export_id=export.id, file_type='pat') }}">PAT</a>
            <a href="{{ url_for('projects.download', project_id=project.id, export_id=export.id, file_type='prn') }}">PRN</a>
            <a href="{{ url_for('projects.download', project_id=project.id, export_id=export.id, file_type='pdf') }}">PDF</a>
            <a href="{{ url_for('projects.download_bundle', project_id=project.id, export_id=export.id) }}">ZIP</a>
        </li>
        {% else %}
        <li>Nenhum arquivo gerado.</li>
        {% endfor %}
    </ul>
</section>
{% endblock %}
