{% extends "base.html" %}
{% block content %}
<section class="project-header">
    <h1>{{ project.name }}</h1>
    <p>Antena: {{ project.antenna.name }} · Frequencia: {{ "%.2f"|format(project.frequency_mhz) }} MHz · Potencia: {{ "%.1f"|format(project.tx_power_w) }} W
    {% if calibrated_gain is not none %} · Ganho calibrado: {{ '%.2f'|format(calibrated_gain) }} dBi{% endif %}
    </p>
    <div class="header-actions">
        <a class="btn" href="{{ url_for('projects.edit', project_id=project.id) }}">Editar</a>
        <a class="btn-primary" href="{{ url_for('projects.export', project_id=project.id) }}">Gerar exportacoes</a>
    </div>
</section>

{% if tech_description %}
<section class="project-tech-description">
    <h2>Descritivo técnico</h2>
    <div class="card">
        <p style="white-space:pre-line">{{ tech_description }}</p>
    </div>
    <hr>
    <h3>Resumo do sistema</h3>
    <table class="table table-compact">
        <thead><tr><th colspan="2">Projeto</th><th colspan="2">Composição</th><th colspan="2">Cabo</th></tr></thead>
        <tbody>
            <tr><td>Antena</td><td>{{ project.antenna.name }}</td><td>Elementos V</td><td>{{ project.v_count }}</td><td>Modelo</td><td>{{ project.cable.model_code if project.cable else (project.cable_type or '—') }}</td></tr>
            <tr><td>Modelo</td><td>{{ project.antenna.model_number or '—' }}</td><td>Δv (m)</td><td>{{ '%.3f'|format(project.v_spacing_m or 0) }}</td><td>Comprimento (m)</td><td>{{ '%.2f'|format(project.cable_length_m or 0) }}</td></tr>
            <tr><td>Frequência</td><td>{{ '%.2f'|format(project.frequency_mhz) }} MHz</td><td>Tilt V (°)</td><td>{{ '%.2f'|format(project.v_tilt_deg or 0) }}</td><td>Splitters (dB)</td><td>{{ '%.2f'|format(project.splitter_loss_db or 0) }}</td></tr>
            <tr><td>Potência TX</td><td>{{ '%.1f'|format(project.tx_power_w) }} W</td><td>Beta V (°)</td><td>{{ '%.2f'|format(project.v_beta_deg or 0) }}</td><td>Conectores (dB)</td><td>{{ '%.2f'|format(project.connector_loss_db or 0) }}</td></tr>
            <tr><td>Altura torre</td><td>{{ '%.2f'|format(project.tower_height_m) }} m</td><td>Nível V</td><td>{{ '%.2f'|format(project.v_level_amp or 0) }}</td><td>Perda total (dB)</td><td>{{ '%.2f'|format(project.feeder_loss_db or 0) }}</td></tr>
            <tr><td>VSWR alvo</td><td>{{ '%.2f'|format(project.vswr_target or 0) }}</td><td>Elementos H</td><td>{{ project.h_count }}</td><td>Impedância (Ω)</td><td>{{ project.cable.impedance_ohms if project.cable else 50 }}</td></tr>
            <tr><td>Ganho nominal</td><td>{{ '%.2f'|format((project.antenna.nominal_gain_dbd or 0)+2.15) }} dBi</td><td>Raio (m)</td><td>{{ '%.3f'|format(project.h_spacing_m or 0) }}</td><td>Fabricante</td><td>{{ project.cable.manufacturer if project.cable else '—' }}</td></tr>
            <tr><td>Notas</td><td colspan="5">{{ project.notes or '—' }}</td></tr>
        </tbody>
    </table>
</section>
{% endif %}
{% if latest_export %}
<section class="export-panel">
    <h2>Downloads do ultimo processamento ({{ latest_export.created_at.strftime('%d/%m/%Y %H:%M') if latest_export.created_at else 'agora' }})</h2>
    <div class="export-grid">
        <article class="export-card export-card--pdf">
            <header>
                <span class="export-icon">📄</span>
                <h3>Relatorio PDF</h3>
            </header>
            <p>Resumo completo com graficos, tabelas e parametros do projeto.</p>
            <a class="export-action" href="{{ latest_files['pdf'] }}">Baixar PDF</a>
        </article>
        <article class="export-card export-card--pat">
            <header>
                <span class="export-icon">📡</span>
                <h3>Arquivo PAT</h3>
            </header>
            <p>Padrão composto 0°-359° compatível com softwares HFSS.</p>
            <a class="export-action" href="{{ latest_files['pat'] }}">Baixar PAT</a>
        </article>
        <article class="export-card export-card--prn">
            <header>
                <span class="export-icon">📈</span>
                <h3>Arquivo PRN</h3>
            </header>
            <p>Tabela de atenuacoes positivas (dB) para simuladores de campo.</p>
            <a class="export-action" href="{{ latest_files['prn'] }}">Baixar PRN</a>
        </article>
        <article class="export-card export-card--bundle">
            <header>
                <span class="export-icon">🗂️</span>
                <h3>Pacote ZIP</h3>
            </header>
            <p>PDF + PAT + PRN em um único pacote para facilitar o envio.</p>
            <a class="export-action" href="{{ latest_files['bundle'] }}">Baixar pacote</a>
        </article>
    </div>
    
</section>
{% endif %}

{% set comp_v_url = (latest_files.get('comp_v') if latest_export else None) or previews.get('comp_vertical', {}).get('image') %}
{% set comp_h_url = (latest_files.get('comp_h') if latest_export else None) or previews.get('comp_horizontal', {}).get('image') %}
<section class="pattern-visuals">
    <article class="pattern-figure">
        <header>
            <h2>Composição Vertical (ilustração)</h2>
        </header>
        {% if comp_v_url %}
        <img src="{{ comp_v_url }}" alt="Composição vertical (atual)" loading="lazy">
        {% else %}
        <p>Sem ilustração disponível.</p>
        {% endif %}
    </article>
    <article class="pattern-figure">
        <header>
            <h2>Composição Horizontal (ilustração)</h2>
        </header>
        {% if comp_h_url %}
        <img src="{{ comp_h_url }}" alt="Composição horizontal (atual)" loading="lazy">
        {% else %}
        <p>Sem ilustração disponível.</p>
        {% endif %}
    </article>
    </section>
<section class="pattern-visuals">
    {% for key, preview in previews.items() %}
    <article class="pattern-figure">
        <header>
            <h2>{{ 'Diagrama de Azimute (original)' if key == 'azimuth' else 'Diagrama de Elevacao (original)' }}</h2>
        </header>
        <img src="{{ preview.image }}" alt="Pre-visualizacao {{ key }}" loading="lazy">
        <ul class="metric-list">
            {% for line in preview.stats %}
            <li>{{ line }}</li>
            {% endfor %}
        </ul>
    </article>
    {% endfor %}
</section>

<section>
    <h2>Tabela HRP (multi-coluna)</h2>
    <table class="table table-compact">
        <thead>
            <tr>
                {% for _ in range(hrp_grid[0]|length) %}
                    <th>Ângulo</th><th>Lin</th><th>dB</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in hrp_grid %}
            <tr>
                {% for cell in row %}
                    {% if cell %}
                        <td>{{ '%.1f'|format(cell.ang) }}</td>
                        <td>{{ '%.4f'|format(cell.lin) }}</td>
                        <td>{{ (cell.db == cell.db) and ('%.2f'|format(cell.db)) or 'N/A' }}</td>
                    {% else %}
                        <td></td><td></td><td></td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<section>
    <h2>Tabela VRP (multi-coluna)</h2>
    <table class="table table-compact">
        <thead>
            <tr>
                {% for _ in range(vrp_grid[0]|length) %}
                    <th>Ângulo</th><th>Lin</th><th>dB</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in vrp_grid %}
            <tr>
                {% for cell in row %}
                    {% if cell %}
                        <td>{{ '%.1f'|format(cell.ang) }}</td>
                        <td>{{ '%.4f'|format(cell.lin) }}</td>
                        <td>{{ (cell.db == cell.db) and ('%.2f'|format(cell.db)) or 'N/A' }}</td>
                    {% else %}
                        <td></td><td></td><td></td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
<section>
    <h2>ERP composto (multi-coluna)</h2>
    <table class="table table-compact">
        <thead>
            <tr>
                {% for _ in range(erp_grid[0]|length) %}
                    <th>Ângulo</th><th>ERP (W)</th><th>ERP (dBW)</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in erp_grid %}
            <tr>
                {% for cell in row %}
                    {% if cell %}
                        <td>{{ '%03d'|format(cell.ang % 360) }}</td>
                        <td>{{ '%.2f'|format(cell.lin) }}</td>
                        <td>{{ '%.2f'|format(cell.db) }}</td>
                    {% else %}
                        <td></td><td></td><td></td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
<section>
    <h2>Exportacoes anteriores</h2>
    <ul>
        {% for export in project.revisions|sort(attribute='created_at', reverse=True) %}
        <li>{{ export.created_at.strftime('%d/%m/%Y %H:%M') if export.created_at else 'sem data' }} -
            <a href="{{ url_for('projects.download', project_id=project.id, export_id=export.id, file_type='pat') }}">PAT</a>
            <a href="{{ url_for('projects.download', project_id=project.id, export_id=export.id, file_type='prn') }}">PRN</a>
            <a href="{{ url_for('projects.download', project_id=project.id, export_id=export.id, file_type='pdf') }}">PDF</a>
            <a href="{{ url_for('projects.download_bundle', project_id=project.id, export_id=export.id) }}">ZIP</a>
        </li>
        {% else %}
        <li>Nenhum arquivo gerado.</li>
        {% endfor %}
    </ul>
</section>
{% endblock %}
